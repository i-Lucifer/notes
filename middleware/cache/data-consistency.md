[TOC]

## 数据一致性

### 介绍

数据库和缓存里的数据不一致

### 产生原因

- 缓存和数据库更新数据时，不是一个原子操作，可能会有一个失败。(双写)

| 策略 | 第一步     | 第二步(假定失败) | 问题                                                         |
| ---- | ---------- | ---------------- | ------------------------------------------------------------ |
| 1    | 更新缓存   | 更新数据库       | 缓存的数据是新数据，过期后，从数据库读数据是旧数据，数据长期不一致 |
| 2    | 更新数据库 | 更新缓存         | 缓存过期前，一直是旧数据，只有过期后，从数据库读的是新数据   |

### 优化策略

- 尽量不要更新缓存，而是删除缓存
  - 比如你数据在1s内更新了100次，但是没有读数据，所以缓存用不到，此时频繁写缓存是浪费
- 删除缓存一样有数据一致性的问题

| 策略 | 第一步     | 第二步(假定失败) | 问题                                                         |
| ---- | ---------- | ---------------- | ------------------------------------------------------------ |
| 1    | 删缓存     | 更新数据库       | 删除数据库失败时，退化为请求错误，高并发场景下，其他请求会重新读数据设置缓存 |
| 2    | 更新数据库 | 删除缓存         | 缓存过期前，一直是旧数据，只有过期后，从数据库读的是新数据   |

### 后删缓存失败解决方案

- 核心思想是重试

  - 失败补偿，失败时，做信息放入补偿队列

  - 监听binlog，比如canal中间件，监听到binlog就删除缓存

- 用来重试的这个程序挂掉了怎么办？
  - 守护进程，自动拉起进程
- 守护进程挂了怎么办？
  - 程序和守护进程都挂了的概率更低了
  - 这是个套娃问题，如果怎样都无法保证应用或者服务的绝对安全可靠
- 其他解决方案
  - 2pc、3pc（两、三阶段提交）分布式协议老保证强一致性，性能比较差

### 核心结论

更新数据库+删除缓存+补偿措施
