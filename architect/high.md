[TOC]

## 三高

| 名词   | 衡量           | 指标       |
| ------ | -------------- | ---------- |
| 高并发 | QPS 每秒查询旅 | 大于10万   |
| 高性能 | 延迟           | 小于100ms  |
| 高可用 | 可用性         | 高于99.99% |

## 高并发策略

### 提升吞吐量

- 集群化部署+负载均衡(LVS+Nginx) 
  - 单台LVS负载量10万(高性能网卡)，LVS负责网络四层转发，无法按HTTP协议中的请求路径做负载均衡，所以还需要Nginx
  - nginx 轮训策略 C10K
    - 轮训，加权，源地址哈希，最小连接
    - 加权轮训，加权随机

- 连接池 池化技术
  - 避免频繁三次握手，四次挥手的时间开销
  - 核心思想 预分配和循环使用
  - 进程池 线程池 协程池 对象池 内存池 连接池
  - 连接池的重要参数 最小连接数 最大连接数 空闲连接数

### 限制非法访问

- 风控分析
  - 同IP多账号，支付时间过快
  - 库存前置校验(定时缓存数据)
- 漏斗限流
- 拦截器分层
  - 网关
  - 应用防火墙

## 高性能

用户体验

- 如果点开一个网页，5s没有响应，绝大多数用户会选择离开

一个结论

- 随着并发数的提升，系统压力增加，平均请求延迟也会增大

### 影响因素

- 用户网络环境
- 请求响应数据包大小
- 业务系统性能 CPU、内存、磁盘、网络
- 业务链路长度
- 下游系统的性能
- 算法是否高效

### 常用优化手段

#### 高性能缓存 (缓存穿透、雪崩、缓存热点、数据一致性)

- 纳秒级 寄存器 L1缓存 L2缓存
- 10纳秒级 L3缓存
- 100纳秒级 本地内存缓存
- <font color="red">分布式缓存</font>

- 多种缓存混合使用
  - 浏览器缓存
  - 服务端本地内存缓存
  - 服务端分布式缓存

#### 日志优化 避免IO瓶颈

- 操作磁盘IO时，可能导致cpu消耗许多时间等待结果，俗称iowait
- io中断时，如果有其他任务可调度，会直接调度其他任务(比如go)
- io中断时，如果系统比较空闲，则会显示iowait(和idle无本质区别)
- 指标 IOPS（类似QPS）
  - 固态硬盘的IOPS大致在3万，如果秒杀时QPS是10万，每次请求产生3条日志，则日志的PS是30万/s
  - tmpfs 临时文件系统，基于内存，由操作系统管理，写磁盘时先写入内存，达到一定的量，会从tmpfs写入到磁盘。(和mysql的redo log比较像)
  - 批量化，顺序写，提高磁盘的吞吐性能

## 高可用

### 评估指标

- 系统可用时长
- 故障恢复所需时间
- 可用性=系统可用时长/(系统可用时长+故障恢复所需时间)

### 高可用策略

- 多云架构
- 异地多活
- 异地备份
- 主备切换 比如Redis 主备
- 熔断、限流 解决流量过载，提供过载保护
- 安全问题 攻击与注入问题(sql注入 脚本注入)

#### 主备切换

- 介绍

  - 当系统出现故障时，首要任务不是立马查找原因，考虑到故障的复杂样，定位排查要花些时间，等问题修复好，SLA也降了好几个档。有没有更快的方式解决这个问题？**那就是故障转移。**

  - 当发现故障节点的时候，不是尝试修复它，而是立即把它隔离，同时将流量转移到正常节点上。这样通过故障转移，不仅减少了故障时间提升了可用性，还为修复故障节点赢得了足够的时间。

- 处理步骤
  - 一、故障自动侦测，比如健康检查，心跳等技术自动侦测故障节点
  - 二、自动转移，当侦测到故障节点，采用限制流量，脱离集群等方式隔离故障节点，将流量转移到正常节点
  - 三、自动恢复，当故障节点回复正常后，自动将其加入集群，确保集群资源与故障前一致

#### 过载保护 熔断与限流

- 过载保护 指超出系统承受能力时，系统会自动采取保护措施，确保自身不会压垮
- 熔断与限流触发策略
  - 比如cpu使用率在一定时间内超过90%
  - 比如错误率超过5%
  - 比如请求延迟超过500ms

| 熔断行为                                                   | 限流行为                                           |
| ---------------------------------------------------------- | -------------------------------------------------- |
| 立即中断服务，确保系统稳定避免崩溃。类似于电路中的保险丝。 | 只处理自己能力范围之内的请求，超量的请求会被限流。 |

#### 降级

- 比如淘宝第一次双十一时，系统无法处理全部流量，通过杀死财务系统，腾出运算资源，供核心业务下订单使用。时候通过订单进行财务数据补救。
- 对非核心功能进行降级，丢车保帅。