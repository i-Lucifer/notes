[TOC]

### QoS 服务质量

#### 发送者与接收者

QoS是Sender和Receiver之间的协议，而不是Publisher和Subscriber之间的协议。

QoS1中Pubisher发送一条数据，只能保证Broker至少收到一次，对应的Sub是否能收到消息，取决于Sub的QoS协商。

- 发送方(Sender)
- 接收方(Receiver) 

#### 质量等级

| 等级 | 说明                           | 最少通讯次数 |
| ---- | ------------------------------ | ------------ |
| 0    | At most once 最多一次          | 1            |
| 1    | At least once 最少一次         | 2            |
| 2    | Exactly once 只有一次 恰好一次 | 4            |

##### 最多一次

| 发送者             | 接收者 |
| ------------------ | ------ |
| 发送数据，丢弃数据 |        |

##### 最少一次

- 这里的ACK包标识（Package Identifier），后面我们简称Id

- 客户端收到ACK的时候知道服务端必定接收到了数据

| 发送者                                    | 接收者                   |
| ----------------------------------------- | ------------------------ |
| 发送数据，保留数据，等待PUB-ACK，超时重试 |                          |
|                                           | 接收数据 返回一次PUB-ACK |
| 接收到ACK，丢弃数据                       |                          |

##### 恰好一次

- 同样使用ID来协调消息的传递
- REC received 收到
- REL release 释放
- COMP complete 完成

| 发送者                                 | 接收者                                           |
| -------------------------------------- | ------------------------------------------------ |
| 发送数据，保留数据，等待消息，超时重试 |                                                  |
|                                        | 接收数据，保留状态，发布收到                     |
| 接收REC，丢弃数据，发送释放            |                                                  |
|                                        | 收到释放，丢弃状态，服务端知道ID可重用，发布完成 |
| 收到完成，客户端知道ID可重用           |                                                  |

